<!DOCTYPE HTML>
<HTML>

<head>
 <title>Panther</title>
 <META http-equiv=Content-Type content='text/html; charset=utf-8'>
 <SCRIPT src=common.js></SCRIPT>
 <SCRIPT src=wdk.js></SCRIPT>
 <SCRIPT src=product.js></SCRIPT>
 <SCRIPT>
wdk.cdbLoad(['$nat_port_trig1-10', '$lan_ip']);

var max = 10;
var listnum;
var curIdx = -1;

function init() {
	var f = document.frm;
	listnum = wdk.cdbLen('$nat_port_trig', max);
	refreshList('$nat_port_trig', max, listnum);
	wdk.getById('usage').innerHTML = listnum + '/' + max;
	f.reset();
	wdk.init_form();
}

function pt_load(s, rng) {
	var prt = rng.split('-');
	var e = s.nextSibling.nextSibling;
	s.value = prt[0].match(/\d+$/);
	e.value = prt[1].match(/\d+$/);
}

function change(add) {
	var f = document.frm;
	var r = '';
	var tab = wdk.findChildNode(wdk.getById('edit'));
	var tports = wdk.getAllByName(tab, 'rp');
	var pritype = wdk.getById('rprot');
	var pport = wdk.getAllByName(tab, 'gp');
	var pubtype = wdk.getById('gprot');
	var en = wdk.getByName(tab, 'en');
	var desc = wdk.getByName(tab, 'desc');

	if (!chkNum(tports[0], 1, 65535, "Trigger Port")) {
		f.rp[0].focus();
		return;
	}
	if (!chkNum(tports[1], 1, 65535, "Trigger Port")) {
		f.rp[1].focus();
		return;
	}
	if (Number(tports[0].value) > Number(tports[1].value)) {
		alert(wdk.msg("Starting Trigger Port should not be greater than Ending Trigger Port!"));
		f.rp[0].focus();
		return;
	}
	if (!chkNum(pport[0], 1, 65535, "Public Port")) {
		f.gp[0].focus();
		return;
	}
	if (!chkNum(pport[1], 1, 65535, "Public Port")) {
		f.gp[1].focus();
		return;
	}
	if (Number(pport[0].value) > Number(pport[1].value)) {
		alert(wdk.msg("Starting Public Port should not be greater than Ending Public Port!"));
		f.gp[0].focus();
		return;
	}
	if (!chkStr(desc, "Comment")) {
		desc.focus();
		return;
	}

	for (var i = 1; i <= listnum; i++) {
		if (!add && i == curIdx) continue;
		if (wdk.cdbVal('$nat_port_trig' + i).indexOf('rp=' + tports[0].value + '-' + tports[1].value + '&') != -1) {
			if (wdk.cdbVal('$nat_port_trig' + i).indexOf('rprot=' + pritype.value + '&') > -1) {
				alert(wdk.msg("Duplicated port range !"));
				return;
			}
			if (pritype.value == "tcp/udp") {
				alert(wdk.msg("Trigger Type overlapped !"));
				return;
			}
		}
		//if (wdk.cdbVal('$nat_port_trig'+i).indexOf('rprot='+pritype.value+'&') < 0)
		{
			var trig_ports = rule2var(wdk.cdbVal('$nat_port_trig' + i), "rp");
			trig_ports = trig_ports.split("-");
			if (checkPort_Collision(Number(trig_ports[0]), Number(trig_ports[1]), Number(tports[0].value), Number(tports[1].value)) == 0) return;
		}
	}
	r = 'en=' + Number(en.checked) + '&rp=' + tports[0].value + '-' + tports[1].value + '&rprot=' + pritype.value + '&gp=' + pport[0].value + '-' + pport[1].value + '&gprot=' + pubtype.value + '&desc=' + desc.value;
	var k = curIdx;
	if (add) {
		k = listnum + 1;
		if (k > max) {
			alert(wdk.msg("Too many entries, maximum is ") + max);
			return
		}
	}
	wdk.cdbSet('$nat_port_trig' + k, r);
	init();
}

function edit(idx) {
	var r = wdk.cdbVal('$nat_port_trig' + idx);
	r = (r == '') ? 'en=0&gp=&desc=' : r;
	wdk.fill_form_entry(wdk.getById('edit'), r);
	markEntry(wdk.getById('$nat_port_trig' + idx));
	curIdx = idx;
}

function Remove(idx) {
	wdk.cdbDel('$nat_port_trig' + idx, max);
	if (curIdx > 2)
		curIdx--;
	init();
}

function checkPort_Collision(sp1, ep1, sp2, ep2) {
	if ((sp2 > ep1) || (ep2 < sp1)) {} else {
		alert(wdk.msg("Port range collision!"));
		return 0;
	}
	return 1;
}

function apply() {
	wdk.save_form(2000);
}
 </SCRIPT>

 <link rel=stylesheet type=text/css href=demo2.css>
</HEAD>

<body class=gui onload=init() onkeydown="(event.keyCode==13) ? 0 : 1">
 <script>
header()
 </script>
 <form name=frm>
  <fieldset>
   <legend>
    <script>
wdk.putmsg("Settings")
    </script>
   </legend>
   <div id=edit>
    <div class=setting>
     <div class=col31>
      <script>
wdk.putmsg("Enabled")
      </script>
     </div>
     <input type=checkbox name=en>
    </div>

    <div class=setting>
     <div class=col31>
      <script>
wdk.putmsg("Trigger Port")
      </script>
     </div>
     <input placeholder="1" maxLength=5 name="rp" size=5 load=pt_load>~
     <input placeholder="65535" maxLength=5 name=rp size=5>
    </div>

    <div class=setting>
     <div class=col31>
      <script>
wdk.putmsg("Trigger Type")
      </script>
     </div>
     <select name=rprot id=rprot>
      <option value=tcp>TCP</option>
      <option value=udp>UDP</option>
      <option value=tcp/udp>
       <script>
wdk.putmsg("Both")
       </script>
      </option>
     </select>
    </div>

    <div class=setting>
     <div class=col31>
      <script>
wdk.putmsg("Public Port")
      </script>
     </div>
     <input placeholder="1" name=gp size=5 maxlength=5 load=pt_load>~
     <input placeholder="65535" name=gp size=5 maxlength=5>
    </div>

    <div class=setting>
     <div class=col31>
      <script>
wdk.putmsg("Type")
      </script>
     </div>
     <select name=gprot id=gprot>
      <option value=tcp>TCP</option>
      <option value=udp>UDP</option>
      <option value=tcp/udp>
       <script>
wdk.putmsg("Both")
       </script>
      </option>
     </select>
    </div>

    <div class=setting>
     <div class=col31>
      <script>
wdk.putmsg("Comment")
      </script>
     </div>
     <input placeholder="Add some comments" maxLength=40 name=desc size=17>
    </div>

    <div class=setting>
     <center>
      <script>
puts('<input type=button class=button name=Add value="' + wdk.msg('Add') + '" onclick=change(1)>' +
	'<input type=button class=button name=Mod value="' + wdk.msg('Modify') + '" onclick=change(0)>');
      </script>
     </center>
    </div>
   </div>
   <div class=setting>
    <div class=col31>
     <script>
wdk.putmsg("Rules Listing")
     </script>
    </div>
    <div class=col3r><span id=usage></span>
     <script>
wdk.putmsg(" (using/max)")
     </script>
    </div>
   </div>
   <div class=floatKiller></div>
   <hr>
   <table class=infolist>
    <tr>
     <th>
     </th>
     <th>
      <script>
wdk.putmsg("Comment")
      </script>
     </th>
     <th>
      <script>
wdk.putmsg("Trigger Port")
      </script>
     </th>
     <th>
      <script>
wdk.putmsg("Public Port")
      </script>
     </th>
     <th>
      <script>
wdk.putmsg("Action")
      </script>
     </th>
    </tr>
    <tr align=center id=$nat_port_trig1>
     <td nowrap>
      <input type=checkbox name=en disabled>
     </td>
     <td>
      <input name=desc disabled>
     </td>
     <td>
      <input name=rprot disabled size=7>
      <input name=rp disabled size=11>
      <td>
       <input name=gprot disabled size=7>
       <input name=gp disabled size=11>
      </td>
      <td>
       <img src=images/edit.gif width=15 height=17 border=0 alt=edit onclick=edit(this.parentNode.parentNode.rowIndex)>&nbsp;
       <img src=images/trash.gif width=15 height=17 border=0 alt=del onclick=Remove(this.parentNode.parentNode.rowIndex)>
      </td>
    </tr>
   </table>
  </fieldset>

  <script>
footer()
  </script>
 </form>

</html>
