<!--ifdef CONFIG_WDS-->
<!DOCTYPE HTML>
<HTML>

<head>
 <title>Panther</title>
 <META http-equiv=Content-Type content='text/html; charset=utf-8'>
 <SCRIPT src=common.js></SCRIPT>
 <SCRIPT src=wdk.js></SCRIPT>
 <SCRIPT src=product.js></SCRIPT>
 <SCRIPT>
wdk.cdbLoad(['$wl_wds_mode', '$wl_wds1-4', '$wl_bss_wep_1key1', '$wl_bss_wep_2key1', '$wl_bss_wep_3key1',
	'$wl_bss_wep_4key1', '$wl_bss_wpa_psk1'
]);

var max = 4;
var listnum;
var curIdx;

function init() {
	var i;
	var f = document.frm;
	var tkip_key = wdk.getById('wl_wds_tp_cp_k');
	var wep_key = "wl_wds_wep_k";
	var wdsMode = wdk.cdbVal('$wl_wds_mode');

	listnum = wdk.cdbLen('$wl_wds', max);
	refreshList('$wl_wds', max, listnum);
	wdk.getById('usage').innerHTML = listnum + '/' + max;

	f.reset();
	wdk.init_form();

	curIdx = -1;

	mode_disp("wds", wdsMode);
	mode_disp("cipher", 0);

	wdk.getById('wl_wds_wep_k1').value = wdk.cdbVal('$wl_bss_wep_1key1');
	wdk.getById('wl_wds_wep_k2').value = wdk.cdbVal('$wl_bss_wep_2key1');
	wdk.getById('wl_wds_wep_k3').value = wdk.cdbVal('$wl_bss_wep_3key1');
	wdk.getById('wl_wds_wep_k4').value = wdk.cdbVal('$wl_bss_wep_4key1');

	wdk.getById('wl_wds_tp_cp_k').value = wdk.cdbVal('$wl_bss_wpa_psk1');
}

function apply() {
	wdk.save_form(2000);
}

function mode_disp(mode, val) {

	var f = document.frm;
	if (mode == "wds") {
		if (val == 1 || val == 2) {
			showHide("wl_wds_disp", 1);
		} else {
			showHide("wl_wds_disp", 0);
		}
	} else if (mode == "cipher") {
		showHide("wl_wds_wep_disp", 0);
		showHide("wl_wds_tp_cp_disp", 0);

		if (val == 12) {
			showHide("wl_wds_wep_disp", 1);
		}
		if (val == 3 || val == 4) {
			showHide("wl_wds_tp_cp_disp", 1);
		}
	}
}

function showCipherMode(element, val) {
	if (val == 0) {
		element.value = "Disable";
	} else if (val == 1 || val == 2) {
		var rowIndex = element.parentNode.parentNode.rowIndex;
		var rule = wdk.cdbVal('$wl_wds' + rowIndex);
		var auth_len = rule2var(rule, 'sec');
		var kidx = rule2var(rule, 'kidx');
		element.value = "WEP(" + auth_len * 64 + "-bit with key index " + kidx + ")";
	} else if (val == 3) {
		element.value = "TKIP";
	} else if (val == 4) {
		element.value = "AES";
	}
}

function edit(idx) {
	var f = document.frm;
	var r = wdk.cdbVal('$wl_wds' + idx);
	var kidx = rule2var(r, 'kidx');
	var modeVal = rule2var(r, 'sec');
	var cipherMode = wdk.getById('wl_wds_cipher_mode');
	r = (r == '') ? 'en=1&mac' : r;
	wdk.fill_form_entry(wdk.getById('edit'), r);
	markEntry(wdk.getById('$wl_wds' + idx));
	curIdx = idx;

	if (modeVal == 1 || modeVal == 2) //wep
	{
		wdk.getById('wl_wds_wep_k1').value = wdk.cdbVal('$wl_bss_wep_1key1');
		wdk.getById('wl_wds_wep_k2').value = wdk.cdbVal('$wl_bss_wep_2key1')
		wdk.getById('wl_wds_wep_k3').value = wdk.cdbVal('$wl_bss_wep_3key1')
		wdk.getById('wl_wds_wep_k4').value = wdk.cdbVal('$wl_bss_wep_4key1')
		cipherMode.value = 12;
		f.wl_wds_key_len.value = modeVal;
		f.wl_wds_wep_k_idx.value = kidx;

	} else {
		wdk.getById('wl_wds_tp_cp_k').value = wdk.cdbVal('$wl_bss_wpa_psk1');
		cipherMode.value = modeVal;
	}

	mode_disp("cipher", cipherMode.value);
}

function Remove(idx) {
	wdk.cdbDel('$wl_wds' + idx, max);
	if (curIdx > 2)
		curIdx--;
	change_init();
}

function change_init() {
	var f = document.frm;
	wdk.cdbSet("$wl_wds_mode", f.$wl_wds_mode.value);
	init();
}

function change(add) {
	var rule = wdk.cdbVal('$wl_wds' + curIdx);
	var modeVal = rule2var(rule, "cipher");
	var f = document.frm;
	var tab = wdk.findChildNode(wdk.getById('edit'));
	var en = wdk.getByName(tab, 'en');
	var mac = wdk.getByName(tab, 'mac');
	var kidx = f.wl_wds_wep_k_idx.value;
	var cipherMode = f.wl_wds_cipher_mode.value;
	var auth_len = f.wl_wds_key_len.value;

	if (curIdx == -1 && !add) return;
	if (!chkMAC(mac, "MAC Address")) {
		mac.focus();
		return;
	}

	for (var i = 1; i <= listnum; i++) {

		if (!add && i == curIdx) continue;
		var line = wdk.cdbVal('$wl_wds' + i);
		if (chkSubStr(line, "mac=" + mac.value, 1)) {
			alert(wdk.msg("Duplicated MAC address."));
			return;
		}
	}

	//wl_wds1=gkey=1&en=1&mac=00:11:22:33:44:55&cipher=1&key=aaaaaaaaaa&kidx=2
	var r = 'gkey=1&' + 'en=' + Number(en.checked) + '&mac=' + mac.value + '&cipher=';
	if (cipherMode == 0) {
		r += '0';
	} else if (cipherMode == 12) //wep
	{
		r += auth_len;

		var obj_wep_key = new Object();
		obj_wep_key.k = new Array();
		obj_wep_key.name = "wep";
		obj_wep_key.id = 'wl_wds_wep_k';
		obj_wep_key.num = 4;
		obj_wep_key.auth_len = f.elements['wl_wds_key_len'].value;

		for (i = 1; i <= obj_wep_key.num; i++) {
			obj_wep_key.k[i] = wdk.getById(obj_wep_key.id + i);

			if (obj_wep_key.k[i].value) {
				if (!key_confirm(obj_wep_key, i)) {
					return;
				}
				wdk.cdbSet('$wl_bss_wep_1key' + i, obj_wep_key.k[i].value);
			} else {
				if (i == kidx) {
					alert(wdk.msg("WEP Key " + i) + wdk.msg(" must input a value !"));
					return;
				}
			}
		}
		r += '&kidx=' + kidx;
	} else if (cipherMode == 3 || cipherMode == 4) //tkip & ccmp
	{
		r += cipherMode; //+'&key=';

		var obj_pre_key = new Object();
		obj_pre_key.k = new Array();
		obj_pre_key.k[0] = wdk.getById('wl_wds_tp_cp_k');
		obj_pre_key.name = "wpa";

		if (!chkStrLen(obj_pre_key.k[0], 8, 63, "Pre-shared Key")) {
			return;
		}
		if (!key_confirm(obj_pre_key, 0)) {
			return;
		}
		wdk.cdbSet('$wl_bss_wpa_psk1', obj_pre_key.k[0].value);

	}

	var k = curIdx;
	if (add) {
		k = listnum + 1;
		if (k > max) {
			alert(wdk.msg("Too many entries, maximum is ") + max);
			return
		}
	}
	wdk.cdbSet('$wl_wds' + k, r);
	change_init();
}

function key_confirm(key, idx) {

	if (key.name == "wep") {
		if ((key.k[idx].value.length == 5 && key.auth_len == 1) |
			(key.k[idx].value.length == 13 && key.auth_len == 2)) {
			if (!chkStr(key.k[idx], 'WEP Key' + idx)) return 0;
			key.tx_val = key.k[idx].value;
			//str2hex(key.k[idx].value, key);
		} else if ((key.k[idx].value.length == 10 && key.auth_len == 1) |
			(key.k[idx].value.length == 26 && key.auth_len == 2)) {
			if (!chkHex(key.k[idx], 'WEP Key' + idx)) return 0;
			key.tx_val = key.k[idx].value;
			//key.tx_val = key.k[idx].value.toLowerCase();
		} else {
			alert('WEP Key' + idx + ' is Invalid');
			return 0;
		}
	} else if (key.name == "wpa") {
		if (!chkPreKey(key.k[idx], "Pre-shared Key")) return 0;
		key.tx_val = key.k[idx].value;
	}

	return 1;
}
 </SCRIPT>

 <link rel=stylesheet type=text/css href=demo2.css>
</HEAD>

<body class=gui onload=init() onkeydown="(event.keyCode==13) ? 0 : 1">
 <script>
header()
 </script>
 <form name=frm>

  <fieldset>
   <legend>
    <script>
wdk.putmsg("Settings");
    </script>
   </legend>
   <div class=setting>
    <div class=label>
     <script>
wdk.putmsg("WDS Mode");
     </script>
    </div>
    <select name=wl_wds_mode id=$wl_wds_mode SIZE=1 onchange="mode_disp('wds',this.value)">
     <option value=0>
      <script>
wdk.putmsg("Disable");
      </script>
     </option>
     <option value=1>
      <script>
wdk.putmsg("Bridge Mode");
      </script>
     </option>
     <option value=2>
      <script>
wdk.putmsg("Repeater Mode");
      </script>
     </option>
    </select>
   </div>

   <div id=wl_wds_disp style="display:none;">
    <hr>
    <br>
    <div class=setting>
     <div class=label>
      <script>
wdk.putmsg("Cipher Mode");
      </script>
     </div>
     <select name=wl_wds_cipher_mode id=wl_wds_cipher_mode SIZE=1 onchange="mode_disp('cipher',this.value)">
      <option value=0>
       <script>
wdk.putmsg("Disable");
       </script>
      </option>
      <option value=12>WEP</option>
      <option value=3>TKIP</option>
      <option value=4>AES</option>
     </select>
    </div>

    <div id=wl_wds_wep_disp style="display:none;">
     <div class=setting>
      <div class=label>
       <script>
wdk.putmsg("Authentication Length");
       </script>
      </div>
      <select name=wl_wds_key_len id=wl_wds_key_len SIZE=1>
       <option value=1>
        <script>
wdk.putmsg("64 Bit");
        </script>
       </option>
       <option value=2>
        <script>
wdk.putmsg("128 Bit");
        </script>
       </option>
      </select>
     </div>

     <div class=setting>
      <div class=label>
       <script>
wdk.putmsg("WEP Key Selection");
       </script>
      </div>
      <select name=wl_wds_wep_k_idx SIZE=1>
       <option value=1>
        <script>
wdk.putmsg("Key 1");
        </script>
       </option>
       <option value=2>
        <script>
wdk.putmsg("Key 2");
        </script>
       </option>
       <option value=3>
        <script>
wdk.putmsg("Key 3");
        </script>
       </option>
       <option value=4>
        <script>
wdk.putmsg("Key 4");
        </script>
       </option>
      </select>
     </div>

     <div class=setting>
      <div class=label>
       <script>
wdk.putmsg("WEP Key1");
       </script>
      </div>
      <input name=wl_wds_wep_k1 id=wl_wds_wep_k1 size=26>
     </div>
     <div class=setting>
      <div class=label>
       <script>
wdk.putmsg("WEP Key2");
       </script>
      </div>
      <input name=wl_wds_wep_k2 id=wl_wds_wep_k2 size=26>
     </div>
     <div class=setting>
      <div class=label>
       <script>
wdk.putmsg("WEP Key3");
       </script>
      </div>
      <input name=wl_wds_wep_k3 id=wl_wds_wep_k3 size=26>
     </div>
     <div class=setting>
      <div class=label>
       <script>
wdk.putmsg("WEP Key4");
       </script>
      </div>
      <input name=wl_wds_wep_k4 id=wl_wds_wep_k4 size=26>

     </div>
    </div>
    <div id="wl_wds_tp_cp_disp" style="display:none;">
     <div class=setting>
      <div class=label>
       <script>
wdk.putmsg("Pre-shared Key");
       </script>
      </div>
      <input id=wl_wds_tp_cp_k size=26 maxlength=63>
     </div>
    </div>

    <div id=edit>

     <div class=setting>
      <div class=col31>
       <script>
wdk.putmsg("Enable")
       </script>
      </div>
      <input type=checkbox name=en>
     </div>
     <div class=setting>
      <div class=label>
       <script>
wdk.putmsg("MAC Address");
       </script>
      </div>
      <div>
       <input placeholder="XX:XX:XX:XX:XX:XX" name=mac size=34 maxlength=17>
      </div>
     </div>

     <div class=setting>
      <center>
       <script>
puts('<input type=button class=button name=Add value="' + wdk.msg('Add') + '" onclick=change(1)>' +
	'<input type=button class=button name=Mod value="' + wdk.msg('Modify') + '" onclick=change(0)>');
       </script>
      </center>
     </div>
    </div>

    <div class=setting>
     <div class=col31>
      <script>
wdk.putmsg("Rules Listing")
      </script>
     </div>
     <div class=col3r><span id=usage></span>
      <script>
wdk.putmsg(" (using/max)")
      </script>
     </div>
    </div>

    <div class=floatKiller></div>
    <hr>
    <br>
    <div>
     <table class=infolist>
      <tr>
       <th>
       </th>
       <th>
        <script>
wdk.putmsg("MAC Address")
        </script>
       </th>
       <th>
        <script>
wdk.putmsg("Cipher Mode")
        </script>
       </th>
       <th>
        <script>
wdk.putmsg("Action")
        </script>
       </th>
      </tr>
      <tr align=center id=$wl_wds1>
       <td>
        <input type=checkbox name=en disabled>
       </td>
       <td>
        <input name=mac disabled>
       </td>
       <td>
        <input name=cipher disabled load=showCipherMode size=23>
       </td>
       <td>
        <img src=images/edit.gif width=15 height=17 border=0 alt=edit onclick=edit(this.parentNode.parentNode.rowIndex)>&nbsp;
        <img src=images/trash.gif width=15 height=17 border=0 alt=del onclick=Remove(this.parentNode.parentNode.rowIndex)>
       </td>
      </tr>
     </table>
    </div>
   </div>

  </fieldset>

  <script>
footer()
  </script>
 </form>

</html>
<!--endif-->
