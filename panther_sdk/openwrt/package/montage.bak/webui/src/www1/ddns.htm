<!DOCTYPE HTML>
<HTML>

<head>
 <title>Panther</title>
 <META http-equiv=Content-Type content='text/html; charset=utf-8'>
 <SCRIPT src=common.js></SCRIPT>
 <SCRIPT src=wdk.js></SCRIPT>
 <SCRIPT src=product.js></SCRIPT>
 <SCRIPT>
wdk.cdbLoad(['$ddns_enable', '$ddns_cfg1']);

var pingResult = -1,
	cnt = 10,
	timer;

function doPing() {
	var f = document.frm,
		s;
	var cmd = 'ping ' + f.hn.value;

	s = wdk.cliCmd(cmd);
	pingResult = /^(seq)/.test(s) ? "2" : "1";
	return;
}

function pingReturn() {
	if (pingResult == -1) {
		wdk.getById('test_result').innerHTML = mag("Testing ...  Failed to update");
		return false;
	}
	var resultstr = (pingResult == "2") ? wdk.msg("Successfully updated") : wdk.msg("Failed to update");

	wdk.getById('test_result').innerHTML = wdk.msg("Testing ...  ") + resultstr;
	return true;
}

function countdown() {
	if (cnt > 0) {
		if (pingResult == -1) cnt--;
		else cnt = 0;
	} else {
		pingReturn();
		clearInterval(timer);
		enable_btn();
		cnt = 10;
	}
}

function init() {
	wdk.init_form();
	showHide('$ddns_cfg1', Number(wdk.cdbVal('$ddns_enable')));
}

function enable_btn() {
	var f = document.frm;
	f.ddnsen.disabled = false;
	f.srv.disabled = false;
	f.hn.disabled = false;
	f.un.disabled = false;
	f.pw.disabled = false;
	f.retry.disabled = false;
	f.ddns_test_btn.disabled = false;
}

function disable_btn() {
	var f = document.frm;
	f.ddnsen.disabled = true;
	f.srv.disabled = true;
	f.hn.disabled = true;
	f.un.disabled = true;
	f.pw.disabled = true;
	f.retry.disabled = true;
	f.ddns_test_btn.disabled = true;
}

function CheckParameter() {
	var f = document.frm;
	var tab = wdk.findChildNode(wdk.getById('$ddns_cfg1'));
	var hn = wdk.getByName(tab, 'hn');
	var un = wdk.getByName(tab, 'un');
	var retry = wdk.getByName(tab, 'retry');

	if (f.ddnsen.checked) {
		if (isBlank(hn)) {
			alert(wdk.msg("Host name can't empty!"));
			return false;
		}
		if (!chkStr(hn, "Host Name")) {
			hn.focus();
			return false;
		}
		if (!chkStr(un, "User Name")) {
			un.focus();
			return false;
		}
		if (!chkNum(retry, 0, 86400, wdk.msg("DDNS Update Interval"))) {
			retry.focus();
			return false;
		}
	}
	return true;
}

function setParameter() {
	var f = document.frm;
	var r = 'en=' + Number(f.ddnsen.checked) + '&srv=' + f.srv.value + '&hn=' + f.hn.value + '&un=' + f.un.value + '&pw=' + f.pw.value + '&retry=' + f.retry.value;
	wdk.cdbSet('$ddns_cfg1', r)
}

function DDNSConfirm() {
	if (CheckParameter() != true) return;
	setParameter();
	//if(wdk.is_form_update()) { alert(wdk.msg("Please save settings first!")); return; }
	pingResult = -1;
	wdk.getById('test_result').innerHTML = wdk.msg("Testing ...  ");
	if (pingResult == -1) {
		disable_btn();
		timer = setInterval("countdown()", 1000);
		doPing();
	}
}

function apply() {
	if (CheckParameter() != true) return;
	setParameter();
	wdk.presubmit_form();
	wdk.save_form(2000);
}
 </SCRIPT>

 <link rel=stylesheet type=text/css href=demo2.css>
</HEAD>

<body class=gui onload=init() onkeydown="(event.keyCode==13) ? 0 : 1">
 <script>
header()
 </script>
 <form name=frm>
  <fieldset>
   <legend>
    <script>
wdk.putmsg("Settings")
    </script>
   </legend>
   <div class=setting>
    <div class=label>
     <script>
wdk.putmsg('Enable DDNS');
     </script>
    </div>
    <input type=checkbox name=ddnsen id=$ddns_enable onclick="showHide('$ddns_cfg1',this.checked)">
    <script>
wdk.putmsg('Enabled')
    </script>
   </div>
   <div id=$ddns_cfg1>
    <input type=hidden name=en>
    <div class=setting>
     <div class=label>
      <script>
wdk.putmsg('Host Name');
      </script>
     </div>
     <input name=hn maxlength=40 size=16>
    </div>
    <div class=setting>
     <div class=label>
      <script>
wdk.putmsg('DDNS Server');
      </script>
     </div>
     <select name=srv SIZE=1>
      <option VALUE=noip>no-ip.com</option>
      <option VALUE=dyndns>dyndns.org</option>
      <option VALUE=changeip>changeip.com</option>
      <option VALUE=regfish>regfish.com</option>
      <option VALUE=oray>www.oray.net</option>
      <!--ifdef CONFIG_DDNS_QDNS-->
      <option VALUE=qdns>members.3322.org</option>
      <!--endif-->
     </select>
    </div>
    <div class=setting>
     <div class=label>
      <script>
wdk.putmsg('User Name');
      </script>
     </div>
     <input name=un maxlength=40 size=8>
    </div>
    <div class=setting>
     <div class=label>
      <script>
wdk.putmsg('Password');
      </script>
     </div>
     <input type=password name=pw maxlength=20 size=8>
    </div>
    <div class=setting>
     <div class=label>
      <script>
wdk.putmsg('DDNS Update Interval');
      </script>
     </div>
     <input name=retry size=4 maxlength=5>(0-86400)
     <script>
wdk.putmsg('Minutes');
     </script>
    </div>
    <div class=setting>
     <div class=label>&nbsp;</div>
     <script>
puts('<input type=button class=button name=ddns_test_btn value="' + wdk.msg('DDNS Ping Test') + '" onclick=DDNSConfirm()>');
     </script>
    </div>
    <div class=setting>
     <div class=label>&nbsp;</div>
     <div id="test_result"></div>
    </div>
   </div>
  </fieldset>

  <script>
footer()
  </script>
 </form>

</html>
