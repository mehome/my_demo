<!--ifdef CONFIG_SONIX_MOTION_DETECTION-->
<!DOCTYPE HTML>
<HTML>

<head>
 <title>Panther</title>
 <META http-equiv=Content-Type content='text/html; charset=utf-8'>
 <SCRIPT src=common.js></SCRIPT>
 <SCRIPT src=wdk.js></SCRIPT>
 <SCRIPT src=product.js></SCRIPT>
 <SCRIPT>
wdk.cdbLoad(['$webcam_md', '$webcam_format']);

var BG_UPDATE_PERIOD = 5000
var BG_DELAY_PERIOD = 1000
var md_do_select = false;
var md_lock_status = 1;

//update background image
function get_bg() {
	var p = wdk.getById("r_total");
	var bp = "cli.cgi?=cmd=snapshot%20";
	bp += new Date().getTime();
	p.style.backgroundImage = "url(" + bp + ")";
}

function req_bg() {
	wdk.cliCmd("webcam md_ctl mdp");
	setTimeout("get_bg()", BG_DELAY_PERIOD);
}

setInterval("req_bg()", BG_UPDATE_PERIOD);

function update_mds() {
	var e = wdk.getById("md_status");
	if (md_lock_status == 1)
		e.value = "";
	else {
		if (md_do_select)
			e.value = "select range";
		else
			e.value = "unselect range";
	}
}

function update_bdr() {
	var e = wdk.getById("r_total");
	if (md_lock_status == 1)
		e.style.borderColor = "black";
	else {
		if (md_do_select)
			e.style.borderColor = "red";
		else
			e.style.borderColor = "green";
	}
}

function mde_toggle(e) {
	if (md_lock_status == 0) {
		md_do_select = !md_do_select;
		//alert(md_do_select);
		update_bdr();
		update_mds();
	}
}

function mde_over(e) {
	if (md_lock_status == 0) {
		if (md_do_select) {
			e.className = "selected";
		} else {
			e.className = "unselected";
		}
	}
}

function mdc_change(e) {
	md_lock_status = e.value; //1: locked, 0: unlocked
	//alert(md_lock_status);
	update_bdr();
	update_mds();
}

function brHide(id, en) {
	var e = wdk.getById(id);
	e.style.display = ((en != 0) ? 'inline' : 'none');
}

function apply() {
	var p = wdk.getById("r_total");
	var ROW = 12;
	var COLUMN = 16;
	var r = 0;
	var c = 0;
	var byte = 0;
	var num = 0;
	var rc = "";
	var str;

	//check
	if (!chkNum(wdk.getById("thr"), 0, 65535, "Threshold")) {
		highlight("thr");
		return;
	}
	if (!chkNum(wdk.getById("rlmt"), 5, 30, "Record Time Limit")) {
		highlight("rlmt");
		return;
	}
	if (!chkNum(wdk.getById("slmt"), 5, 30, "Snapshot Time Limit")) {
		highlight("slmt");
		return;
	}
	if (!chkNum(wdk.getById("sint"), 1, 5, "Snapshot times per second")) {
		highlight("sint");
		return;
	}

	// 12x16(2B)
	// R0 : B0   B1
	// ....
	// R11: B190 B191
	// BitOrder: LSM -> MSB
	for (var r = 0; r < ROW; r++) {
		for (var c = 0; c < COLUMN; c++) {
			if (num && (num % 8 == 0)) {
				var s = byte.toString(16);
				if (s.length < 2)
					rc += "0";
				rc += s;
				byte = 0;
			}
			var id = "r" + r + "c" + c;
			var e = wdk.getById(id);
			if (e.className == "selected")
				byte |= 1 << (num % 8);
			num++;
		}
	}
	var s = byte.toString(16);
	if (s.length < 2)
		rc += "0";
	rc += s;

	// set $webcam_md
	var thr = wdk.getById("thr").value;
	var en = wdk.getById("en").checked ? 1 : 0;
	var ren = wdk.getById("ren").checked ? 1 : 0;
	var sen = wdk.getById("sen").checked ? 1 : 0;
	var rlmt = wdk.getById("rlmt").value;
	var sint = wdk.getById("sint").value;
	var slmt = wdk.getById("slmt").value;
	str = "en=" + en;
	str += "&thr=" + thr;
	str += "&msk=" + rc;
	str += "&ren=" + ren;
	str += "&rlmt=" + rlmt;
	str += "&sen=" + sen;
	str += "&sint=" + sint;
	str += "&slmt=" + slmt;
	wdk.cdbSet("$webcam_md", str)
	if (wdk.cdbChg("$webcam_md")) {
		// sent commands
		/*WSIM_BEGIN*/
		alert("webcam md_ctl mda " + en + "_" + thr + "_" + rc + "_" + ren + "_" + rlmt + "_" + sen + "_" + sint + "_" + slmt);
		/*WSIM_END*/
		wdk.cliCmd("webcam md_ctl mda " + en + "_" + thr + "_" + rc + "_" + ren + "_" + rlmt + "_" + sen + "_" + sint + "_" + slmt);

		wdk.save_form(0, 1);
		wdk.showResultBG();
		wdk.redirect(5);
	} else
		alert(wdk.msg('The settings are not changed!!'));
}

function update_md_wall() {
	var p = wdk.getById("r_total");
	var ROW = 12;
	var COLUMN = 16;
	var r = 0;
	var c = 0;
	var md = wdk.cdbVal('$webcam_md');
	var msk = rule2var(md, "msk");
	var byte0 = 0;
	var byte1 = 0;
	var num = 0;
	// 12x16(2B)
	// R0 : B0   B1
	// ....
	// R11: B190 B191
	// BitOrder: LSM -> MSB
	for (var r = 0; r < ROW; r++) {
		byte0 = parseInt("0x" + msk.substr(4 * (num / COLUMN), 2));
		byte1 = parseInt("0x" + msk.substr(4 * (num / COLUMN) + 2, 2));
		for (var c = 0; c < COLUMN; c++) {
			var s = false;
			var a = wdk.getById("r" + r + "c" + c);
			if (c >= (COLUMN / 2)) {
				if (byte1 & (1 << (num % 8)))
					s = true;
			} else {
				if (byte0 & (1 << (num % 8)))
					s = true;
			}
			if (s)
				a.setAttribute("class", "selected");
			else
				a.setAttribute("class", "unselected");
			num++;
			p.appendChild(a);
		}
	}
	update_mds();
}

function create_md_wall() {
	var p = wdk.getById("r_total");
	var ROW = 12;
	var COLUMN = 16;
	var r = 0;
	var c = 0;
	var num = 0;
	for (var r = 0; r < ROW; r++) {
		for (var c = 0; c < COLUMN; c++) {
			var a = document.createElement("div");
			a.setAttribute("id", "r" + r + "c" + c);
			a.setAttribute("onclick", "mde_toggle(this)");
			a.setAttribute("onmouseover", "mde_over(this)");

			num++;
			p.appendChild(a);
		}
	}
	update_mds();
}

function init() {
	var f = document.frm;

	// decide the width and height of r_total
	var format = wdk.cdbVal('$webcam_format');
	var vcode = rule2var(format, "vcode");
	var res = rule2var(format, "res");
	if (res == "1280x720" || res == "1920x1080") {
		wdk.getById("r_total").style.width = "480px";
		wdk.getById("r_total").style.height = "270px";
	} else {
		wdk.getById("r_total").style.width = "480px";
		wdk.getById("r_total").style.height = "360px";
	}

	f.reset();
	wdk.init_form();

	showHide('mdopt', wdk.getById("en").checked);
	showHide('r_total', wdk.getById("en").checked);
	brHide('d_br', wdk.getById("en").checked);
	showHide('div_rlmt', wdk.getById("ren").checked);
	showHide('div_sint', wdk.getById("sen").checked);
	showHide('div_slmt', wdk.getById("sen").checked);

	update_md_wall();
	req_bg();
}
 </SCRIPT>
 <style type=text/css>
#r_total {
 width: 480px;
 height: 360px;
 border: 1px solid black;
 background-repeat: no-repeat;
 background-size: contain;
 margin: 0px auto;
}
#r_total div.selected {
 width: 6.25%;
 height: 8.3333%;
 border: 0px;
 float: left;
 background-color: red;
 opacity: 0.3;
}
#r_total div.unselected {
 width: 6.25%;
 height: 8.3333%;
 border: 0px;
 float: left;
 opacity: 0.3;
}
 </style>

 <link rel=stylesheet type=text/css href=demo2.css>
</HEAD>

<body class=gui onload=init() onkeydown="(event.keyCode==13) ? 0 : 1">
 <script>
header()
 </script>
 <form name=frm>
  <fieldset id=$webcam_md>
   <legend>
    <script>
wdk.putmsg("Settings")
    </script>
   </legend>
   <div class=setting>
    <div class=label>
     <script>
wdk.putmsg("Enabled");
     </script>
    </div>
    <input type=checkbox name=en id=en value=1 onclick="brHide('d_br',this.checked);showHide('mdopt',this.checked);showHide('r_total',this.checked)">
   </div>
   <div id=mdopt>
    <div class=setting>
     <div class=label>
      <script>
wdk.putmsg("Threshold");
      </script>
      &nbsp;(0~65535)
     </div>
     <input name=thr id=thr>
    </div>
    <div class=setting>
     <div class=label>
      <script>
wdk.putmsg("Record to SD card");
      </script>
     </div>
     <input type=checkbox name=ren id=ren value=1 onclick="showHide('div_rlmt',this.checked)">
    </div>
    <div class=setting id=div_rlmt>
     <div class=label>
      <script>
wdk.putmsg("Record Time Limit");
      </script>
      &nbsp;(5~30)
     </div>
     <input name=rlmt id=rlmt value=1>&nbsp;seconds
    </div>
    <div class=setting>
     <div class=label>
      <script>
wdk.putmsg("Snapshot to SD card");
      </script>
     </div>
     <input type=checkbox name=sen id=sen value=1 onclick="showHide('div_sint',this.checked);showHide('div_slmt',this.checked)">
    </div>
    <div class=setting id=div_sint>
     <div class=label>
      <script>
wdk.putmsg("Snapshot times");
      </script>
      &nbsp;(1~5)
     </div>
     <input name=sint id=sint value=1>&nbsp;times per second
    </div>
    <div class=setting id=div_slmt>
     <div class=label>
      <script>
wdk.putmsg("Snapshot Time Limit");
      </script>
      &nbsp;(5~30)
     </div>
     <input name=slmt id=slmt value=1>&nbsp;seconds
    </div>
    <div class=setting>
     <div class=label>
      <script>
wdk.putmsg("Selection");
      </script>
     </div>
     <input type=radio name=MDL value=1 onclick="mdc_change(this)" checked>locked
     <input type=radio name=MDL value=0 onclick="mdc_change(this)">unlocked
     <input name=md_status id=md_status size=20 readonly>
    </div>
   </div>
  </fieldset>
  <br id=d_br>
  <div id=r_total>
   <script>
create_md_wall();
   </script>
  </div>
  <script>
footer(0)
  </script>
 </form>

</html>
<!--endif-->
